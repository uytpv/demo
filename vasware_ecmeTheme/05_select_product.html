<!DOCTYPE html>
<html class="light" lang="vi">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Chọn Sản Phẩm - VasWare</title>
  <link rel="stylesheet" href="css/base/reset.css" />
  <link rel="stylesheet" href="css/variables.css" />
  <link rel="stylesheet" href="css/components/components.css" />
  <link rel="stylesheet" href="css/layouts/main-layout.css" />
  <link rel="stylesheet" href="css/components/page-heading.css" />
  <link rel="stylesheet" href="css/components/search.css" />
  <link rel="stylesheet" href="css/pages/product/product.css" />
  <link rel="stylesheet" href="css/pages/product/fab-timer-override.css" />
  <link rel="stylesheet" href="css/components/fab-menu.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
    rel="stylesheet" />
</head>

<body>
  <div class="main-layout">
    <!-- Top Navigation -->
    <div class="top-nav">
      <button class="top-nav-menu-btn" id="menuBtn">
        <span class="material-symbols-outlined">menu</span>
      </button>
      <div class="top-nav-center">
        <div class="top-nav-logo">
          <img src="assets/images/logo.png" alt="VasWare Logo"
            style="width: 100%; height: 100%; object-fit: contain;" />
        </div>
        <div class="top-nav-title">VasWare</div>
      </div>
      <button class="top-nav-notification-btn">
        <span class="material-symbols-outlined">notifications</span>
        <span class="notification-badge"></span>
      </button>
    </div>

    <!-- Main Layout Wrapper -->
    <div class="main-layout-wrapper">
      <!-- Sidebar Menu -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
          <nav style="display: flex; flex-direction: column; gap: 8px;">
            <a href="#" class="sidebar-link">
              <span class="sidebar-icon material-symbols-outlined">schedule</span>
              <span>Thẻ giờ</span>
            </a>
            <a href="09_sickleave.html" class="sidebar-link">
              <span class="sidebar-icon material-symbols-outlined">sick</span>
              <span>Nghỉ bệnh</span>
            </a>
            <a href="#" class="sidebar-link">
              <span class="sidebar-icon material-symbols-outlined">help</span>
              <span>Hướng dẫn</span>
            </a>
            <a href="#" class="sidebar-link">
              <span class="sidebar-icon material-symbols-outlined">policy</span>
              <span>Quy định làm việc</span>
            </a>
            <a href="#" class="sidebar-link">
              <span class="sidebar-icon material-symbols-outlined">person</span>
              <span>Hồ sơ người dùng</span>
            </a>
          </nav>
        </div>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
          <nav style="display: flex; flex-direction: column; gap: 8px;">
            <a href="#" class="sidebar-link">
              <span class="sidebar-icon material-symbols-outlined">settings</span>
              <span>Cài đặt</span>
            </a>
            <a href="index.html" class="sidebar-link">
              <span class="sidebar-icon material-symbols-outlined">logout</span>
              <span>Đăng xuất</span>
            </a>
          </nav>
          <div class="sidebar-user">
            <div class="sidebar-user-email">nhanvien@vasware.com</div>
            <div style="font-size: 12px; color: #9ca3af;">Internal worker</div>
          </div>
          <div class="sidebar-version">v1.0.0</div>
        </div>
      </aside>

      <!-- Sidebar Overlay (Mobile) -->
      <div class="sidebar-overlay" id="sidebarOverlay"></div>

      <!-- Main Content -->
      <div class="main-content-area">
        <div class="list">
          <!-- Product Grid View -->
          <div class="view" id="productGridView">
            <!-- Search Bar -->
            <div class="search-bar">
              <div class="search-wrapper">
                <span class="search-icon material-symbols-outlined">search</span>
                <input type="text" class="search-input" placeholder="Tìm kiếm sản phẩm..." id="searchInput" />
              </div>
              <button class="product-barcode-btn" id="barcodeBtn" title="Quét mã vạch">
                <span class="material-symbols-outlined">qr_code_scanner</span>
              </button>
            </div>
            <!-- Product Grid -->
            <div class="product-grid" id="productGrid">
              <!-- Products will be generated by JavaScript -->
            </div>
          </div>

          <!-- Timer Detail Views (Hidden by default) -->
          <div class="view" id="timerDetailView" style="display: none;">
            <div class="timer-detail-content" id="timerDetailContent">
              <!-- Product & Performance Section -->
              <div class="timer-detail-section product-detail-section">
                <div class="product-detail-row">
                  <div class="product-detail-image">
                    <img id="detailProductImage" src="" alt="Product" />
                  </div>
                  <div class="product-detail-info">
                    <div class="product-detail-header">
                      <h3 id="detailProductName" class="product-detail-name">Tên sản phẩm</h3>
                      <p id="detailProductCode" class="product-detail-code">Mã: 0000</p>
                    </div>
                  </div>
                </div>

                <!-- Action Buttons removed - moved to FAB menu -->
              </div>

              <!-- Timer & Performance Section -->
              <div class="timer-detail-section performance-section">
                <div class="performance-bg-wrapper">
                  <div class="large-timer" id="detailTimer">00:00:00</div>
                  <div class="performance-display">
                    <div class="performance-label-small">Hiệu suất trung bình</div>
                    <div class="performance-value-large" id="performanceValue">380</div>
                    <div class="performance-status-bar">
                      <div class="status-bar-fill" id="statusBarFill" style="width: 95%;"></div>
                    </div>
                    <div class="product-detail-stats">
                      <div class="stat-item">
                        <span class="stat-label">Hoàn thành</span>
                        <div class="stat-value-unit">
                          <span class="stat-value" id="completedBoxes">2</span>
                          <span class="stat-unit">(400 cái)</span>
                        </div>
                      </div>
                      <div class="stat-item">
                        <span class="stat-label">Mục tiêu</span>
                        <div class="stat-value-unit">
                          <span class="stat-value">400</span>
                          <span class="stat-unit">(cái/h)</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <button class="btn btn-add-box" id="addBoxBtn">+ Thêm hộp</button>
                </div>
              </div>

              <!-- Statistics Table -->
              <div class="timer-detail-section stats-section">
                <div class="stats-title-container" id="statsToggle">
                  <span class="material-symbols-outlined stats-arrow" id="statsArrow">expand_more</span>
                  <h4 class="stats-title">Thống kê</h4>
                </div>
                <div class="stats-table collapsed" id="statsTable">
                  <div class="stats-header">
                    <div class="stats-col product-code-col">Mã SP</div>
                    <div class="stats-col boxes-col">Hoàn thành</div>
                    <div class="stats-col time-col">Bắt đầu</div>
                    <div class="stats-col time-col">Kết thúc</div>
                  </div>
                  <div class="stats-row">
                    <div class="stats-col product-code-col">3061U</div>
                    <div class="stats-col boxes-col">2</div>
                    <div class="stats-col time-col">08:30</div>
                    <div class="stats-col time-col">08:35</div>
                  </div>
                  <div class="stats-row">
                    <div class="stats-col product-code-col">3096U</div>
                    <div class="stats-col boxes-col">5</div>
                    <div class="stats-col time-col">08:36</div>
                    <div class="stats-col time-col">08:42</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Completion Modal -->
          <div class="modal" id="completionModal" style="display: none;">
            <div class="modal-overlay" id="modalOverlay"></div>
            <div class="modal-content">
              <div class="modal-header">
                <h2 class="modal-title">Hoàn tất</h2>
                <button class="modal-close-btn" id="modalCloseBtn">
                  <span class="material-symbols-outlined">close</span>
                </button>
              </div>
              <div class="modal-body" id="modalBody">
                <!-- Content will be filled later -->
              </div>
            </div>
          </div>
        </div>

        <!-- Task Timer Section -->
        <div class="product-section task-timer-section">
          <div class="timer-header timer-header-inline" id="taskToggle" style="cursor: pointer;">
            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
              <span class="material-symbols-outlined task-arrow" id="taskArrow"
                style="font-size: 20px; color: #6b7280; transition: transform 0.3s ease;">expand_more</span>
              <div class="timer-name" id="taskName">C-Hallii: Vastaanotto / Receiving - Display Mì / Noodle Display
              </div>
            </div>
            <div class="timer-btn-display" id="taskTimer">00:00:00</div>
          </div>
          <div class="task-subtasks collapsed" id="taskSubtasks">
            <div class="timer-header timer-header-inline">
              <div class="timer-name">A-Hallii - Konti</div>
              <div class="time-range">07:00 - 09:00</div>
            </div>
            <div class="timer-header timer-header-inline">
              <div class="timer-name">D-Hallii - Lumene Display</div>
              <div class="time-range">09:00 - 11:00</div>
            </div>
          </div>
        </div>

        <!-- Shift Timer Section -->
        <div class="shift-timer-section">
          <div class="shift-timer-header shift-timer-header-inline">
            <div class="shift-timer-label">Tổng thời gian làm việc</div>
            <div class="timer-btn-display" id="shiftTimer">00:00:00</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Sample product data
    const products = [
      { id: 1, name: 'Buldak Cheese', code: '3061U', image: 'assets/images/products/product-01.jpg' },
      { id: 2, name: 'Buldak Hot Chicken', code: '3096U', image: 'assets/images/products/product-02.jpg' },
      { id: 3, name: 'Buldak Musta', code: '3097U', image: 'assets/images/products/product-03.jpg' },
      { id: 4, name: 'Buldak Carbonara', code: '3060U', image: 'assets/images/products/product-04.jpg' }
    ];

    let taskStartTime = Date.now();
    let shiftStartTime = Date.now(); // In real app, this would be from previous page

    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const taskTimer = document.getElementById('taskTimer');
    const shiftTimer = document.getElementById('shiftTimer');
    const productGrid = document.getElementById('productGrid');

    // Toggle sidebar
    function toggleSidebar() {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('open');
    }

    menuBtn.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);

    // Render product grid
    function renderProducts() {
      productGrid.innerHTML = products.map(product => `
        <a href="#" class="product-item" data-product-id="${product.id}">
          <div class="product-image">
            <img src="${product.image}" alt="${product.name}" />
          </div>
          <p class="product-name">${product.name}</p>
          <p class="product-code">${product.code}</p>
        </a>
      `).join('');
    }

    // Format timer display
    function formatTime(milliseconds) {
      const totalSeconds = Math.floor(milliseconds / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // Get elapsed minutes
    function getElapsedMinutes(startTime) {
      return Math.floor((Date.now() - startTime) / 60000);
    }

    // Update break button state - No longer used (buttons moved to FAB)
    function updateBreakButtonState() {
      // Empty - logic moved to FAB menu
    }

    // Helper function for testing - use in console like: setShiftMinutes(90)
    // Expose shiftStartTime for FAB menu
    window.shiftStartTime = shiftStartTime;
    window.setShiftMinutes = function (minutes) {
      shiftStartTime = Date.now() - (minutes * 60 * 1000);
      window.shiftStartTime = shiftStartTime;
      console.log(`Shift time set to ${minutes} minutes. Current shift elapsed:`, getElapsedMinutes(shiftStartTime));
      // Trigger break button state update if available
      if (window.updateBreakButtonState) {
        window.updateBreakButtonState();
        console.log('Break button state updated.');
      }
    }

    // Helper to set task time - use like: setTaskMinutes(45)
    // This sets the TASK time, which shows on the timer
    window.setTaskMinutes = function (minutes) {
      taskStartTime = Date.now() - (minutes * 60 * 1000);
      console.log(`Task time set to ${minutes} minutes. Current task elapsed:`, getElapsedMinutes(taskStartTime));
    }

    // Update timers
    function updateTimers() {
      const taskElapsed = Date.now() - taskStartTime;
      const shiftElapsed = Date.now() - shiftStartTime;

      taskTimer.textContent = formatTime(taskElapsed);
      shiftTimer.textContent = formatTime(shiftElapsed);

      // Update detail timer if it exists and is visible
      const detailTimer = document.getElementById('detailTimer');
      if (detailTimer) {
        detailTimer.textContent = formatTime(taskElapsed);
      }

      updateBreakButtonState();
    }

    // Swipe gesture handler for slider buttons
    function addSwipeSlider(element, callback, isDisabledCheck = null) {
      const thumb = element.querySelector('[class*="-thumb"]');
      const track = element;
      let isActive = false;
      let startX = 0;

      track.addEventListener('mousedown', handleStart);
      track.addEventListener('touchstart', handleStart);

      function handleStart(e) {
        if (isDisabledCheck && isDisabledCheck()) {
          return;
        }
        isActive = true;
        startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('touchmove', handleMove);
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);
      }

      function handleMove(e) {
        if (!isActive) return;

        const currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const diff = currentX - startX;
        const trackWidth = track.offsetWidth;
        const thumbWidth = thumb.offsetWidth;
        const maxTranslate = trackWidth - thumbWidth;

        // Constrain between 0 and max
        const translate = Math.max(0, Math.min(diff, maxTranslate));
        thumb.style.transform = `translateX(${translate}px)`;
      }

      function handleEnd(e) {
        if (!isActive) return;
        isActive = false;

        const currentTransform = thumb.style.transform;
        const translateValue = currentTransform ? parseInt(currentTransform.match(/\d+/)[0]) : 0;
        const trackWidth = track.offsetWidth;
        const thumbWidth = thumb.offsetWidth;
        const maxTranslate = trackWidth - thumbWidth;

        // If swiped more than 50% of the way
        if (translateValue > maxTranslate * 0.5) {
          // Complete the swipe
          thumb.style.transform = `translateX(${maxTranslate}px)`;
          thumb.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

          setTimeout(() => {
            callback();
          }, 300);
        } else {
          // Reset
          thumb.style.transform = 'translateX(0px)';
          thumb.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        }

        document.removeEventListener('mousemove', handleMove);
        document.removeEventListener('touchmove', handleMove);
        document.removeEventListener('mouseup', handleEnd);
        document.removeEventListener('touchend', handleEnd);
      }
    }


    // Swipe slider calls removed - buttons moved to FAB menu
    // View routing (SPA)
    const productGridView = document.getElementById('productGridView');
    const timerDetailView = document.getElementById('timerDetailView');
    const timerDetailContent = document.getElementById('timerDetailContent');

    // Show product grid view
    function showProductGridView() {
      productGridView.style.display = 'block';
      timerDetailView.style.display = 'none';
    }

    // Show timer detail view for a product
    function showTimerDetailView(productId) {
      const product = products.find(p => p.id === parseInt(productId));
      if (!product) return;

      // Update product info
      document.getElementById('detailProductImage').src = product.image;
      document.getElementById('detailProductName').textContent = product.name;
      document.getElementById('detailProductCode').textContent = `Mã: ${product.code}`;

      // Update performance (sample data)
      const completedBoxes = Math.floor(Math.random() * 10) + 1;
      document.getElementById('completedBoxes').textContent = completedBoxes;

      // Update performance value (sample)
      const performanceValue = Math.floor(Math.random() * (450 - 300) + 300);
      document.getElementById('performanceValue').textContent = performanceValue;

      // Helper function to determine status class
      function getStatusClass(value) {
        if (value < 350) return 'status-danger';
        if (value < 400) return 'status-warning';
        return 'status-safe';
      }

      // Helper function to get status text
      function getStatusText(value) {
        if (value < 350) return 'Nguy hiểm';
        if (value < 400) return 'Giảm';
        return 'An toàn';
      }

      // Helper function to get status color
      function getStatusColor(value) {
        if (value < 350) return '#ef4444';
        if (value < 400) return '#f59e0b';
        return '#10b981';
      }

      const statusClass = getStatusClass(performanceValue);
      const statusColor = getStatusColor(performanceValue);

      // Update status bar and text based on performance
      const statusBarFill = document.getElementById('statusBarFill');
      const performanceDisplay = document.querySelector('.performance-display');
      const performanceBgWrapper = document.querySelector('.performance-bg-wrapper');
      const detailTimer = document.getElementById('detailTimer');
      const performanceValueElement = document.getElementById('performanceValue');
      const completedBoxesElement = document.getElementById('completedBoxes');

      // Get target value element (the one showing 400)
      const targetValueElements = document.querySelectorAll('.stat-value');
      let targetElement = null;
      if (targetValueElements.length > 1) {
        targetElement = targetValueElements[1]; // Second stat-value is the target
      }

      // Remove all status classes
      performanceDisplay.classList.remove('status-danger', 'status-warning', 'status-safe');
      performanceBgWrapper.classList.remove('status-danger', 'status-warning', 'status-safe');
      detailTimer.classList.remove('status-danger', 'status-warning', 'status-safe');
      performanceValueElement.classList.remove('status-danger', 'status-warning', 'status-safe');
      completedBoxesElement.classList.remove('status-danger', 'status-warning', 'status-safe');
      if (targetElement) targetElement.classList.remove('status-danger', 'status-warning', 'status-safe');

      // Add status class to all elements
      performanceDisplay.classList.add(statusClass);
      performanceBgWrapper.classList.add(statusClass);
      detailTimer.classList.add(statusClass);
      performanceValueElement.classList.add(statusClass);
      completedBoxesElement.classList.add(statusClass);
      if (targetElement) targetElement.classList.add(statusClass);

      // Update status bar
      statusBarFill.style.width = (performanceValue / 450 * 100) + '%';
      statusBarFill.style.backgroundColor = statusColor;

      productGridView.style.display = 'none';
      timerDetailView.style.display = 'block';
    }

    // Modal handlers
    const completionModal = document.getElementById('completionModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const completeBtn = document.getElementById('completeBtn');
    const switchProductBtn = document.getElementById('switchProductBtn');
    const addBoxBtn = document.getElementById('addBoxBtn');

    // Open completion modal (only if button exists - button removed in FAB version)
    if (completeBtn) {
      completeBtn.addEventListener('click', () => {
        completionModal.style.display = 'flex';
      });
    }

    // Close modal
    function closeModal() {
      completionModal.style.display = 'none';
    }

    modalCloseBtn.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);

    // Switch product (back to grid) - only if button exists
    if (switchProductBtn) {
      switchProductBtn.addEventListener('click', showProductGridView);
    }

    // Add box button
    addBoxBtn.addEventListener('click', () => {
      const completedBoxes = document.getElementById('completedBoxes');
      const current = parseInt(completedBoxes.textContent);
      completedBoxes.textContent = current + 1;
      console.log('Box added. Total:', current + 1);
    });

    // Product selection - Switch to timer detail view
    productGrid.addEventListener('click', (e) => {
      const productItem = e.target.closest('.product-item');
      if (productItem) {
        e.preventDefault();
        const productId = productItem.dataset.productId;
        showTimerDetailView(productId);
      }
    });

    // Statistics table toggle
    const statsToggle = document.getElementById('statsToggle');
    const statsTable = document.getElementById('statsTable');
    const statsArrow = document.getElementById('statsArrow');

    if (statsToggle) {
      statsToggle.addEventListener('click', () => {
        statsTable.classList.toggle('collapsed');
        statsArrow.classList.toggle('expanded');
      });
    }

    // Task subtasks toggle
    const taskToggle = document.getElementById('taskToggle');
    const taskSubtasks = document.getElementById('taskSubtasks');
    const taskArrow = document.getElementById('taskArrow');

    if (taskToggle) {
      taskToggle.addEventListener('click', () => {
        taskSubtasks.classList.toggle('collapsed');
        taskArrow.classList.toggle('expanded');
      });
    }

    // Initialize
    renderProducts();
    updateTimers();
    setInterval(updateTimers, 1000);
  </script>

  <!-- Overlay for Speed Dial -->
  <div class="fab-overlay" id="fabOverlay"></div>

  <!-- Speed Dial Container -->
  <div class="fab-speed-dial">
    <!-- Speed Dial Actions (stack vertically above FAB) -->
    <div class="fab-speed-dial-actions" id="fabActions">
      <!-- Action 1: Hoàn tất -->
      <div class="fab-action-item" data-action="complete">
        <span class="fab-action-label">Hoàn tất</span>
        <button class="fab-action-button" id="fabCompleteBtn">
          <span class="material-symbols-outlined">check_circle</span>
        </button>
      </div>

      <!-- Action 2: Chuyển sản phẩm -->
      <div class="fab-action-item" data-action="switchProduct">
        <span class="fab-action-label">Chuyển sản phẩm</span>
        <button class="fab-action-button" id="fabSwitchProductBtn">
          <span class="material-symbols-outlined">swap_horiz</span>
        </button>
      </div>

      <!-- Action 3: Chuyển việc -->
      <div class="fab-action-item" data-action="switchTask">
        <span class="fab-action-label">Chuyển việc</span>
        <button class="fab-action-button" id="fabSwitchTaskBtn">
          <span class="material-symbols-outlined">task_alt</span>
        </button>
      </div>

      <!-- Action 4: Giải lao -->
      <div class="fab-action-item" data-action="break">
        <span class="fab-action-label" id="fabBreakLabel">Giải lao</span>
        <button class="fab-action-button" id="fabBreakBtn">
          <span class="material-symbols-outlined">coffee</span>
        </button>
      </div>

      <!-- Action 5: Kết thúc ca -->
      <div class="fab-action-item" data-action="endShift">
        <span class="fab-action-label">Kết thúc ca</span>
        <button class="fab-action-button" id="fabEndShiftBtn">
          <span class="material-symbols-outlined">logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main FAB Button -->
  <button class="fab-button" id="fabButton" aria-label="Menu hành động">
    <span class="material-symbols-outlined fab-icon">add</span>
  </button>

  <!-- FAB Menu Script -->
  <script src="js/fab-menu.js"></script>
</body>

</html>